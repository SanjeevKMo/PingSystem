<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Agency Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      display: none;
    }
    .alert.show {
      display: block;
    }
    .alert.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Test Agency Form Submission</h1>

  <div class="info">
    <strong>Instructions:</strong><br>
    1. First, login to the admin panel at <a href="HTML/admin-login.html" target="_blank">admin-login.html</a><br>
    2. This will store a JWT token in localStorage<br>
    3. Then come back and fill this form<br>
    4. The form will use the stored token to create the agency
  </div>

  <div id="alert" class="alert"></div>

  <form id="agencyForm">
    <div class="form-group">
      <label for="name">Agency Name *</label>
      <input type="text" id="name" name="name" placeholder="e.g., Ministry of Health" required>
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" name="description" placeholder="Short description"></textarea>
    </div>

    <div class="form-group">
      <label for="icon_emoji">Icon Emoji</label>
      <input type="text" id="icon_emoji" name="icon_emoji" placeholder="e.g., üè•">
    </div>

    <div class="form-group">
      <label for="color_code">Color Code</label>
      <input type="text" id="color_code" name="color_code" placeholder="#FF5733">
    </div>

    <div class="form-group">
      <label for="contact_email">Contact Email</label>
      <input type="email" id="contact_email" name="contact_email" placeholder="admin@example.gov">
    </div>

    <div class="form-group">
      <label for="contact_phone">Contact Phone</label>
      <input type="text" id="contact_phone" name="contact_phone" placeholder="+1234567890">
    </div>

    <button type="submit">Create Agency</button>
    <button type="reset">Clear</button>
  </form>

  <script>
    const API_URL = 'http://localhost:5001/api';

    function showAlert(message, type) {
      const alertEl = document.getElementById('alert');
      alertEl.textContent = message;
      alertEl.className = `alert show ${type}`;
      
      if (type === 'success') {
        setTimeout(() => {
          alertEl.className = 'alert';
        }, 3000);
      }
    }

    document.getElementById('agencyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Form submitted');

      // Get token
      const token = localStorage.getItem('authToken');
      if (!token) {
        showAlert('‚ùå No auth token found. Please login first.', 'error');
        console.error('Token not found in localStorage');
        return;
      }

      const form = document.getElementById('agencyForm');
      const fd = new FormData(form);
      
      const payload = {
        name: fd.get('name'),
        description: fd.get('description') || null,
        icon_emoji: fd.get('icon_emoji') || null,
        color_code: fd.get('color_code') || null,
        contact_email: fd.get('contact_email') || null,
        contact_phone: fd.get('contact_phone') || null
      };

      console.log('Payload:', payload);
      console.log('Token:', token.substring(0, 30) + '...');

      try {
        const response = await fetch(`${API_URL}/agencies`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        console.log('Response status:', response.status);
        const json = await response.json();
        console.log('Response body:', json);

        if (!response.ok) {
          throw new Error(json.message || 'Failed to create agency');
        }

        showAlert(`‚úÖ Agency "${json.data.name}" created successfully (ID: ${json.data.id})`, 'success');
        form.reset();
      } catch (err) {
        console.error('Error:', err);
        showAlert(`‚ùå Error: ${err.message}`, 'error');
      }
    });

    // Check on page load
    window.addEventListener('load', () => {
      const token = localStorage.getItem('authToken');
      if (token) {
        console.log('‚úÖ Auth token found in localStorage');
        showAlert('‚úÖ Auth token found. Form is ready.', 'success');
      } else {
        console.warn('‚ö†Ô∏è No auth token in localStorage');
        showAlert('‚ö†Ô∏è No auth token found. Please login at admin-login.html first.', 'error');
      }
    });
  </script>
</body>
</html>
